<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Assefa Digital Bingo Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* All your existing CSS styles remain exactly the same */
        /* Keeping all the same styles for consistency */
    </style>
</head>
<body>
    <!-- Audio Elements -->
    <audio id="callAudio" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="winAudio" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-disconnected">
        <span id="statusIcon">üî¥</span>
        <span id="statusText">Connecting...</span>
    </div>

    <!-- Triple Border Container -->
    <div class="border-container">
        <div class="main-container">
            <!-- Color Borders -->
            <div class="page-border green"></div>
            <div class="page-border yellow"></div>
            <div class="page-border red"></div>

            <!-- Page 0: Welcome -->
            <div class="page-container active" id="page0">
                <button class="help-circle-btn" onclick="showPage(5)">?</button>
                
                <div class="page-content">
                    <div class="welcome-content">
                        <div class="game-title">Assefa Digital Bingo Game</div>
                        <div style="font-size: 14px; color: #ffd700; margin-bottom: 30px; text-align: center;">
                            Assefa Gashaye Birhanie Digital Bingo Game (AGBDBG)
                        </div>
                        <button class="start-btn-circle" onclick="showPage(1)">
                            <div style="font-size: 24px;">üéÆ</div>
                        </button>
                        <div class="developer-text">Developed by Assefa Gashaye Birhanie</div>
                    </div>
                </div>
            </div>

            <!-- Page 1: Board Selection -->
            <div class="page-container" id="page1">
                <div class="page-content">
                    <div class="page-header">Select Board Type</div>
                    <div class="board-selection-container">
                        <div class="board-type-grid" id="boardTypeGrid"></div>
                    </div>
                </div>
                
                <div class="fixed-controls">
                    <button class="control-btn btn-secondary" onclick="showPage(0)">Back</button>
                    <button class="control-btn btn-success" id="nextBtn">Continue</button>
                </div>
            </div>

            <!-- Page 2: Registration -->
            <div class="page-container" id="page2">
                <div class="page-content">
                    <!-- Registration Top Bar -->
                    <div class="registration-top-bar">
                        <button class="top-bar-btn win-btn" onclick="showPotentialWin()">üèÜ</button>
                        <div class="registration-title">Registration</div>
                        <button class="top-bar-btn members-btn" onclick="showMembers()">üë•</button>
                    </div>
                    
                    <div class="registration-form">
                        <div class="form-scroll">
                            <div class="form-group">
                                <label for="playerName">Full Name</label>
                                <input type="text" id="playerName" class="form-control" placeholder="Your full name">
                            </div>
                            
                            <div class="form-group">
                                <label for="playerPhone">Phone Number</label>
                                <input type="tel" id="playerPhone" class="form-control" placeholder="0918203416">
                            </div>
                            
                            <div class="payment-section">
                                <select id="paymentAmount" class="payment-select" onchange="processPayment()">
                                    <option value="">Select Payment Amount</option>
                                    <option value="25">25 Birr</option>
                                    <option value="50">50 Birr</option>
                                    <option value="100">100 Birr</option>
                                    <option value="200">200 Birr</option>
                                    <option value="500">500 Birr</option>
                                    <option value="1000">1000 Birr</option>
                                    <option value="2000">2000 Birr</option>
                                    <option value="5000">5000 Birr</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="playerStake">Stake Amount</label>
                                <select id="playerStake" class="form-control" onchange="updatePotentialWin()">
                                    <option value="">Select Stake</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="boardSelect">Board Number</label>
                                <select id="boardSelect" class="form-control">
                                    <option value="">1-100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fixed-controls">
                    <button class="control-btn btn-secondary" onclick="showPage(1)">Back</button>
                    <button class="control-btn btn-success" id="confirmBtn">Start Game</button>
                </div>
            </div>

            <!-- Page 3: Game Board -->
            <div class="page-container" id="page3">
                <div class="game-header">
                    <div class="game-title-bar" id="gameHeader"></div>
                </div>
                
                <div class="game-board-container">
                    <div id="gameBoard"></div>
                </div>
                
                <!-- Circular Call Button -->
                <div class="circular-call-container">
                    <div class="called-numbers-bar" id="calledNumbersBar">
                        <!-- Numbers will be added here -->
                    </div>
                </div>
                
                <!-- Game Controls -->
                <div class="game-controls">
                    <button class="control-btn btn-secondary" onclick="showPage(2)">Back</button>
                    <button class="control-btn btn-info" onclick="showPage(4)">Finance</button>
                    <button class="control-btn btn-success" onclick="announceWin()" id="announceBtn">I'm Winner!</button>
                </div>
            </div>

            <!-- Page 4: Finance -->
            <div class="page-container" id="page4">
                <div class="page-content">
                    <div class="page-header">Finance</div>
                    
                    <div class="finance-container">
                        <div class="finance-form">
                            <div class="form-group">
                                <label>Total Payment</label>
                                <input type="text" id="totalPayment" class="form-control" readonly value="0 Birr">
                            </div>
                            
                            <div class="form-group">
                                <label>Total Winnings</label>
                                <input type="text" id="totalWon" class="form-control" readonly value="0 Birr">
                            </div>
                            
                            <div class="form-group">
                                <label>Current Balance</label>
                                <input type="text" id="currentBalance" class="form-control" readonly value="0 Birr">
                            </div>
                            
                            <div class="form-group">
                                <label for="withdrawAccount">Account Number</label>
                                <input type="text" id="withdrawAccount" class="form-control" placeholder="1000062264911">
                            </div>
                            
                            <div class="form-group">
                                <label for="withdrawAmount">Available for Withdrawal</label>
                                <input type="text" id="withdrawAmount" class="form-control" readonly value="0 Birr">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fixed-controls">
                    <button class="control-btn btn-secondary" onclick="showPage(3)">Back</button>
                    <button class="control-btn btn-success" onclick="processWithdrawal()">Withdraw</button>
                </div>
            </div>

            <!-- Page 5: Detailed Help Information -->
            <div class="page-container" id="page5">
                <div class="page-content">
                    <div class="page-header">Help & Instructions</div>
                    
                    <!-- Help Navigation -->
                    <div class="help-nav">
                        <button class="help-nav-btn active" onclick="showHelpTab('general')">General</button>
                        <button class="help-nav-btn" onclick="showHelpTab('rules')">Rules</button>
                        <button class="help-nav-btn" onclick="showHelpTab('75ball')">75-Bingo</button>
                        <button class="help-nav-btn" onclick="showHelpTab('90ball')">90-Bingo</button>
                        <button class="help-nav-btn" onclick="showHelpTab('30ball')">30-Bingo</button>
                        <button class="help-nav-btn" onclick="showHelpTab('50ball')">50-Bingo</button>
                        <button class="help-nav-btn" onclick="showHelpTab('pattern')">Pattern Bingo</button>
                        <button class="help-nav-btn" onclick="showHelpTab('coverall')">Coverall</button>
                        <button class="help-nav-btn" onclick="showHelpTab('winning')">Winning Process</button>
                        <button class="help-nav-btn" onclick="showHelpTab('payment')">Payment System</button>
                    </div>
                    
                    <div class="help-content">
                        <!-- General Tab -->
                        <div class="help-tab-content active" id="help-general">
                            <div class="help-section">
                                <div class="help-title">What is Bingo?</div>
                                <div class="help-text">
                                    Bingo is a game of chance where numbers are randomly drawn and players mark them on their cards. The first to complete a pattern calls "Bingo" and wins.
                                </div>
                            </div>
                            
                            <div class="help-section">
                                <div class="help-title">Game Structure</div>
                                <div class="help-text">
                                    1. Game Page 6: Different board types<br>
                                    2. Registration Page: Player info and payment<br>
                                    3. Game Board: Number marking and winning<br>
                                    4. Finance Page: Balance and withdrawal<br>
                                    5. Help Page: Detailed instructions
                                </div>
                            </div>
                        </div>
                        
                        <!-- All other help tabs remain with English content -->
                        <!-- (Keeping the structure but changing content to English) -->
                        
                    </div>
                </div>
                
                <div class="fixed-controls">
                    <button class="control-btn btn-success" onclick="showPage(0)">Back to Home</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Members Modal -->
    <div class="members-modal" id="membersModal">
        <div class="modal-content">
            <div class="modal-header">Players (<span id="membersCount">0</span>)</div>
            
            <table class="members-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Payment</th>
                        <th>Stake</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="membersList">
                    <!-- Members will be added here -->
                </tbody>
            </table>
            
            <div class="fixed-controls" style="position: relative; margin-top: 15px; background: transparent; border: none;">
                <button class="control-btn btn-success" onclick="closeModal('membersModal')">OK</button>
            </div>
        </div>
    </div>

    <!-- Potential Win Modal -->
    <div class="potential-win-modal" id="potentialWinModal">
        <div class="modal-content">
            <div class="modal-header">Winning Potential</div>
            
            <table class="winning-table">
                <thead>
                    <tr>
                        <th>Stake Amount</th>
                        <th>Prize</th>
                    </tr>
                </thead>
                <tbody id="winningTableBody">
                    <!-- Winning amounts will be added here -->
                </tbody>
            </table>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border: 1px solid #ffd700;">
                <div style="text-align: center; font-size: 14px; color: #28a745; margin-top: 5px; font-weight: bold;">
                    Potential Win: <span id="currentWinDisplay">0</span> Birr
                </div>
                <div style="text-align: center; font-size: 11px; color: #ffd700; margin-top: 5px;">
                    Note: 3% service charge deducted
                </div>
            </div>
            
            <div class="fixed-controls" style="position: relative; margin-top: 15px; background: transparent; border: none;">
                <button class="control-btn btn-success" onclick="closeModal('potentialWinModal')">OK</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="notification" id="notification">
        <div id="notificationText"></div>
        <div class="fixed-controls" style="position: relative; margin-top: 15px; background: transparent; border: none;">
            <button class="control-btn btn-secondary" onclick="hideNotification()">OK</button>
            <button class="control-btn btn-success" id="continueBtn" onclick="continueWithIncomplete()">Continue</button>
        </div>
    </div>

    <!-- Winner Popup -->
    <div class="winner-notification" id="winnerNotification">
        <div style="font-size: 32px; margin-bottom: 15px;">üéâ BINGO! üéâ</div>
        <div class="winner-name" id="winnerName"></div>
        <div class="winning-pattern" id="winPattern"></div>
        <div class="win-amount" id="displayWinAmount">0 Birr</div>
        <div style="margin: 15px 0; color: #ffd700;" id="winnerStatus">Verifying...</div>
        <div class="fixed-controls" style="position: relative; bottom: 0; left: 0; right: 0; margin-top: 20px; background: transparent; border: none;">
            <button class="control-btn btn-success" onclick="continueGame()" id="continueGameBtn">Continue</button>
            <button class="control-btn btn-info" onclick="showPage(4)">Withdraw</button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div style="color: #ffd700; font-weight: bold; text-align: center; margin-bottom: 15px;">
            Admin Panel - Active Players: <span id="activePlayers">0</span>
        </div>
        <div class="admin-controls">
            <button class="admin-btn admin-start" onclick="sendAdminCommand('start')">Start Game</button>
            <button class="admin-btn admin-stop" onclick="sendAdminCommand('stop')">Stop Game</button>
            <button class="admin-btn admin-call" onclick="sendAdminCommand('call')">Call Number</button>
            <button class="admin-btn admin-reset" onclick="sendAdminCommand('reset')">Reset Game</button>
        </div>
        <div style="color: white; font-size: 12px; text-align: center; margin-top: 10px;">
            Numbers Called: <span id="adminCalledCount">0</span>
        </div>
        <div class="fixed-controls" style="position: relative; margin-top: 15px; background: transparent; border: none;">
            <button class="control-btn btn-secondary" onclick="toggleAdminPanel()">Close</button>
        </div>
    </div>

    <script>
        // WebSocket Configuration - FIXED URL
        const WS_URL = 'wss://ameng-gogs-finance3-63.deno.dev/';
        const API_URL = 'https://ameng-gogs-finance3-63.deno.dev/';

        // Game State
        const gameState = {
            gameType: null,
            payment: 0,
            paymentAmount: 25,
            stake: 25,
            totalWon: 0,
            boardId: 1,
            calledNumbers: [],
            markedNumbers: new Set(),
            gameActive: false,
            playerName: '',
            playerPhone: '',
            totalWithdrawn: 0,
            members: [],
            currentNumber: null,
            winningPatterns: {
                '75ball': ['row', 'column', 'diagonal', 'four-corners', 'full-house'],
                '90ball': ['one-line', 'two-lines', 'full-house'],
                '30ball': ['full-house'],
                '50ball': ['row', 'column', 'diagonal', 'four-corners', 'full-house'],
                'pattern': ['x-pattern', 'frame', 'postage-stamp', 'small-diamond'],
                'coverall': ['full-board']
            },
            winConditions: {
                'row': 'Row',
                'column': 'Column',
                'diagonal': 'Diagonal',
                'four-corners': 'Four Corners',
                'full-house': 'Full House',
                'one-line': 'One Line',
                'two-lines': 'Two Lines',
                'x-pattern': 'X Pattern',
                'frame': 'Frame',
                'postage-stamp': 'Postage Stamp',
                'small-diamond': 'Small Diamond',
                'full-board': 'Full Board'
            },
            ws: null,
            playerId: null,
            isAdmin: false,
            adminPassword: 'asse2123',
            connectionAttempts: 0,
            maxConnectionAttempts: 5,
            reconnectTimeout: null,
            pingInterval: null
        };

        // Board Types
        const boardTypes = [
            { id: '75ball', name: '75-Bingo', icon: 'üéØ', desc: '5√ó5 with BINGO', range: 75, columns: 5 },
            { id: '90ball', name: '90-Bingo', icon: 'üá¨üáß', desc: '9√ó3 Fast Game', range: 90, columns: 9 },
            { id: '30ball', name: '30-Bingo', icon: '‚ö°', desc: '3√ó3 Speed Game', range: 30, columns: 3 },
            { id: '50ball', name: '50-Bingo', icon: 'üé≤', desc: '5√ó5 with BINGO', range: 50, columns: 5 },
            { id: 'pattern', name: 'Pattern Bingo', icon: '‚ú®', desc: 'Special Patterns', range: 75, columns: 5 },
            { id: 'coverall', name: 'Coverall', icon: 'üèÜ', desc: 'Mark All Numbers', range: 90, columns: 9 }
        ];

        // WebSocket Functions
        function connectWebSocket() {
            try {
                updateConnectionStatus('connecting', 'Connecting...');
                
                // Clear any existing connection
                if (gameState.ws) {
                    gameState.ws.close();
                }
                
                const ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    console.log('WebSocket connected successfully');
                    updateConnectionStatus('connected', 'Connected');
                    gameState.connectionAttempts = 0;
                    
                    // Setup ping to keep connection alive
                    gameState.pingInterval = setInterval(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: 'ping' }));
                        }
                    }, 30000);
                    
                    // Check admin access
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('admin') === 'true') {
                        const password = prompt('Enter admin password:', '');
                        if (password === gameState.adminPassword) {
                            gameState.isAdmin = true;
                            sendMessage({ type: 'admin_login', password: password });
                            showAdminPanel();
                        }
                    }
                };
                
                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('Received:', message.type, message);
                        handleWebSocketMessage(message);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                };
                
                ws.onclose = (event) => {
                    console.log('WebSocket disconnected:', event.code, event.reason);
                    updateConnectionStatus('disconnected', 'Disconnected');
                    
                    // Clear ping interval
                    if (gameState.pingInterval) {
                        clearInterval(gameState.pingInterval);
                        gameState.pingInterval = null;
                    }
                    
                    // Attempt reconnection
                    if (gameState.connectionAttempts < gameState.maxConnectionAttempts) {
                        gameState.connectionAttempts++;
                        const delay = Math.min(30000, 3000 * Math.pow(2, gameState.connectionAttempts));
                        
                        console.log(`Reconnecting in ${delay}ms (attempt ${gameState.connectionAttempts})`);
                        updateConnectionStatus('connecting', `Reconnecting in ${delay/1000}s...`);
                        
                        gameState.reconnectTimeout = setTimeout(() => {
                            connectWebSocket();
                        }, delay);
                    } else {
                        showNotification('Unable to connect to server. Please refresh the page.', false);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus('disconnected', 'Connection Error');
                };
                
                gameState.ws = ws;
            } catch (error) {
                console.error('Failed to connect:', error);
                updateConnectionStatus('disconnected', 'Connection Failed');
            }
        }

        function sendMessage(message) {
            if (gameState.ws && gameState.ws.readyState === WebSocket.OPEN) {
                gameState.ws.send(JSON.stringify(message));
                console.log('Sent:', message.type, message);
                return true;
            } else {
                console.warn('WebSocket not connected');
                showNotification('Not connected to server', false);
                return false;
            }
        }

        function handleWebSocketMessage(message) {
            switch(message.type) {
                case 'connected':
                    gameState.playerId = message.playerId;
                    updateConnectionStatus('connected', `Connected as Player ${message.playerId}`);
                    // Request initial game state
                    sendMessage({ type: 'get_state' });
                    break;
                    
                case 'game_state':
                    updateGameState(message.state);
                    break;
                    
                case 'number_called':
                    handleNumberCalled(message.number);
                    break;
                    
                case 'game_started':
                    showNotification('Game started! Numbers are being called...', false);
                    gameState.gameActive = true;
                    break;
                    
                case 'game_stopped':
                    showNotification('Game stopped', false);
                    gameState.gameActive = false;
                    break;
                    
                case 'winner_announced':
                    handleWinnerAnnounced(message.winnerName, message.pattern, message.amount);
                    break;
                    
                case 'winner_verified':
                    handleWinnerVerified(message.winnerId, message.verified);
                    break;
                    
                case 'players_update':
                    updatePlayersList(message.players);
                    break;
                    
                case 'error':
                    showNotification(message.message, false);
                    break;
                    
                case 'admin_login_success':
                    gameState.isAdmin = true;
                    showNotification('Welcome to Admin Panel', false);
                    showAdminPanel();
                    break;
                    
                case 'admin_login_failed':
                    gameState.isAdmin = false;
                    showNotification('Incorrect password', false);
                    break;
                    
                case 'pong':
                    // Keep connection alive
                    break;
            }
        }

        function updateGameState(state) {
            console.log('Updating game state:', state);
            
            if (state.calledNumbers) {
                gameState.calledNumbers = state.calledNumbers;
                updateCalledNumbersDisplay();
            }
            
            if (state.gameActive !== undefined) {
                gameState.gameActive = state.gameActive;
                // Update game header
                if (gameState.gameActive) {
                    document.getElementById('gameHeader').textContent += ' - Game Active';
                }
            }
            
            if (state.players) {
                updatePlayersList(state.players);
            }
            
            if (gameState.isAdmin) {
                document.getElementById('activePlayers').textContent = state.players ? state.players.length : 0;
                document.getElementById('adminCalledCount').textContent = state.calledNumbers ? state.calledNumbers.length : 0;
            }
        }

        function handleNumberCalled(number) {
            gameState.calledNumbers.push(number);
            
            // Update UI
            const bar = document.getElementById('calledNumbersBar');
            const span = document.createElement('span');
            span.className = 'called-number';
            span.textContent = number;
            bar.appendChild(span);
            
            // Keep only last 8 numbers
            while (bar.children.length > 8) {
                bar.removeChild(bar.firstChild);
            }
            
            // Scroll to end
            bar.scrollLeft = bar.scrollWidth;
            
            // Play sound
            const audio = document.getElementById('callAudio');
            audio.currentTime = 0;
            audio.play().catch(() => {});
            
            // Mark number on board if exists
            markNumberOnBoard(number);
        }

        function markNumberOnBoard(number) {
            const cells = document.querySelectorAll('.board-cell[data-number]');
            cells.forEach(cell => {
                if (parseInt(cell.dataset.number) === number) {
                    if (!cell.classList.contains('marked')) {
                        cell.classList.add('marked');
                        gameState.markedNumbers.add(number);
                        
                        // Check for win
                        checkForWin();
                    }
                }
            });
        }

        function updatePlayersList(players) {
            gameState.members = players;
            document.getElementById('membersCount').textContent = players.length;
            
            // Update members list in modal
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            players.forEach((player, index) => {
                const row = document.createElement('tr');
                row.className = 'member-row';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="member-name">${player.name || 'Guest'}</td>
                    <td>${player.phone || 'N/A'}</td>
                    <td class="member-paid">‚úì</td>
                    <td>${player.stake || 25} Birr</td>
                    <td>${player.balance || 0} Birr</td>
                `;
                membersList.appendChild(row);
            });
        }

        function handleWinnerAnnounced(winnerName, pattern, amount) {
            // Show winner notification to all players
            document.getElementById('winnerName').textContent = winnerName;
            document.getElementById('winPattern').textContent = gameState.winConditions[pattern] || pattern;
            document.getElementById('displayWinAmount').textContent = `${amount.toLocaleString()} Birr`;
            document.getElementById('winnerStatus').textContent = 'Verifying...';
            document.getElementById('winnerNotification').style.display = 'block';
            
            // Play win sound
            const audio = document.getElementById('winAudio');
            audio.currentTime = 0;
            audio.play().catch(() => {});
        }

        function handleWinnerVerified(winnerId, verified) {
            if (gameState.playerId === winnerId) {
                if (verified) {
                    document.getElementById('winnerStatus').textContent = 'Verified ‚úì';
                    document.getElementById('continueGameBtn').style.display = 'flex';
                    
                    // Update player's winnings
                    const winAmount = calculatePotentialWin(gameState.stake);
                    gameState.totalWon += winAmount;
                    updateFinance();
                    
                    showNotification(`Congratulations! You won ${winAmount.toLocaleString()} Birr!`, false);
                } else {
                    document.getElementById('winnerStatus').textContent = 'Not verified ‚úó';
                    document.getElementById('continueGameBtn').style.display = 'flex';
                    showNotification('Win claim rejected by server', false);
                }
            }
        }

        // Update Connection Status UI
        function updateConnectionStatus(status, text) {
            const statusDiv = document.getElementById('connectionStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            
            statusDiv.className = `connection-status status-${status}`;
            statusText.textContent = text;
            
            switch(status) {
                case 'connected':
                    statusIcon.textContent = 'üü¢';
                    break;
                case 'disconnected':
                    statusIcon.textContent = 'üî¥';
                    break;
                case 'connecting':
                    statusIcon.textContent = 'üü°';
                    break;
            }
        }

        // Admin Functions
        function showAdminPanel() {
            const panel = document.getElementById('adminPanel');
            if (gameState.isAdmin) {
                panel.style.display = 'block';
            }
        }

        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            if (gameState.isAdmin) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }

        function sendAdminCommand(command) {
            if (!gameState.isAdmin) {
                showNotification('Admin access required', false);
                return;
            }
            
            sendMessage({ type: 'admin_command', command: command });
        }

        // Calculate potential win
        function calculatePotentialWin(stake) {
            const validMembers = 90; // Fixed 90 members
            const potential = (0.8 * validMembers * stake * 0.97);
            return Math.floor(potential);
        }

        // Initialize
        function init() {
            setupBoardSelection();
            setupStakeOptions();
            setupBoardNumbers();
            updatePotentialWin();
            
            // Connect to WebSocket
            connectWebSocket();
            
            // Setup event handlers
            document.getElementById('nextBtn').onclick = () => {
                if (gameState.gameType) {
                    showPage(2);
                } else {
                    showNotification('Please select a board type', false);
                }
            };
            
            document.getElementById('confirmBtn').onclick = confirmRegistration;
            document.getElementById('playerStake').onchange = updatePotentialWin;
            document.getElementById('paymentAmount').onchange = processPayment;
            document.getElementById('announceBtn').onclick = announceWin;
            
            updateCalledNumbersDisplay();
            
            // Initialize game state
            gameState.calledNumbers = [];
            gameState.markedNumbers.clear();
        }

        // Setup Board Selection
        function setupBoardSelection() {
            const grid = document.getElementById('boardTypeGrid');
            grid.innerHTML = '';
            
            boardTypes.forEach(type => {
                const card = document.createElement('div');
                card.className = 'board-type-card';
                card.innerHTML = `
                    <div class="board-type-icon">${type.icon}</div>
                    <div class="board-type-title">${type.name}</div>
                    <div class="board-type-desc">${type.desc}</div>
                `;
                card.onclick = () => {
                    document.querySelectorAll('.board-type-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.gameType = type.id;
                    
                    // For pattern bingo, select a random pattern
                    if (type.id === 'pattern') {
                        const patterns = gameState.winningPatterns.pattern;
                        gameState.currentPattern = patterns[Math.floor(Math.random() * patterns.length)];
                    }
                };
                
                grid.appendChild(card);
            });
        }

        // Setup Stake Options
        function setupStakeOptions() {
            const select = document.getElementById('playerStake');
            const stakes = [25, 50, 100, 200, 500, 1000, 2000, 5000];
            stakes.forEach(stake => {
                const option = document.createElement('option');
                option.value = stake;
                option.textContent = `${stake} Birr`;
                select.appendChild(option);
            });
            select.value = 25;
            gameState.stake = 25;
        }

        // Setup Board Numbers
        function setupBoardNumbers() {
            const select = document.getElementById('boardSelect');
            for (let i = 1; i <= 100; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Board ${i}`;
                select.appendChild(option);
            }
            select.value = 1;
        }

        // Show Page
        function showPage(pageNum) {
            document.querySelectorAll('.page-container').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page${pageNum}`).classList.add('active');
            
            if (pageNum === 3) {
                generateGameBoard();
            }
            if (pageNum === 4) {
                updateFinance();
            }
            if (pageNum === 5) {
                showHelpTab('general');
            }
        }

        // Show Help Tab
        function showHelpTab(tabId) {
            document.querySelectorAll('.help-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.help-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`.help-nav-btn[onclick="showHelpTab('${tabId}')"]`).classList.add('active');
            document.getElementById(`help-${tabId}`).classList.add('active');
        }

        // Show Members Modal
        function showMembers() {
            document.getElementById('membersModal').style.display = 'block';
        }

        // Show Potential Win Modal
        function showPotentialWin() {
            const tbody = document.getElementById('winningTableBody');
            tbody.innerHTML = '';
            
            const stakes = [25, 50, 100, 200, 500, 1000, 2000, 5000];
            stakes.forEach(stake => {
                const winAmount = calculatePotentialWin(stake);
                const row = document.createElement('tr');
                row.className = stake === gameState.stake ? 'current-stake-row' : '';
                row.innerHTML = `
                    <td>${stake} Birr</td>
                    <td class="win-amount">${winAmount.toLocaleString()} Birr</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('potentialWinModal').style.display = 'block';
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Update Potential Win Display
        function updatePotentialWin() {
            const stake = parseInt(document.getElementById('playerStake').value) || 25;
            const winAmount = calculatePotentialWin(stake);
            
            document.getElementById('currentWinDisplay').textContent = winAmount.toLocaleString();
            gameState.stake = stake;
        }

        // Show Notification
        function showNotification(message, showContinue) {
            document.getElementById('notificationText').textContent = message;
            document.getElementById('continueBtn').style.display = showContinue ? 'flex' : 'none';
            document.getElementById('notification').style.display = 'block';
        }

        // Hide Notification
        function hideNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        // Continue with incomplete information
        function continueWithIncomplete() {
            hideNotification();
            gameState.playerName = document.getElementById('playerName').value || 'Guest';
            gameState.playerPhone = document.getElementById('playerPhone').value || '0000000000';
            gameState.stake = parseInt(document.getElementById('playerStake').value) || 25;
            gameState.boardId = document.getElementById('boardSelect').value || 1;
            showPage(3);
        }

        // Process Payment
        function processPayment() {
            const amount = parseInt(document.getElementById('paymentAmount').value);
            
            if (!amount || amount < 25) {
                return;
            }
            
            gameState.payment = amount;
            gameState.paymentAmount = amount;
            
            const select = document.getElementById('paymentAmount');
            select.style.background = '#28a745';
            select.style.color = 'white';
        }

        // Confirm Registration
        function confirmRegistration() {
            const name = document.getElementById('playerName').value;
            const phone = document.getElementById('playerPhone').value;
            const stake = document.getElementById('playerStake').value;
            const board = document.getElementById('boardSelect').value;
            
            const incomplete = !name || !phone || !stake || !board || gameState.payment === 0;
            
            if (incomplete) {
                showNotification('Incomplete information. Do you want to continue?', true);
                return;
            }
            
            gameState.playerName = name;
            gameState.playerPhone = phone;
            gameState.stake = parseInt(stake);
            gameState.boardId = board;
            
            // Send registration to server
            const success = sendMessage({
                type: 'register',
                playerName: name,
                playerPhone: phone,
                stake: gameState.stake,
                boardId: gameState.boardId,
                gameType: gameState.gameType
            });
            
            if (success) {
                showPage(3);
            }
        }

        // Generate Game Board - This function is large but remains mostly the same
        // I'll include the key parts but keep it similar to your original
        function generateGameBoard() {
            const board = document.getElementById('gameBoard');
            const header = document.getElementById('gameHeader');
            const type = boardTypes.find(t => t.id === gameState.gameType);
            
            board.innerHTML = '';
            header.textContent = `${type.name} - Board ${gameState.boardId}`;
            
            // Reset marked numbers for new game
            gameState.markedNumbers.clear();
            
            switch(gameState.gameType) {
                case '75ball':
                case '50ball':
                    generateBingoBoard(type);
                    break;
                case '90ball':
                    generate90BallBoard(type);
                    break;
                case '30ball':
                    generate30BallBoard(type);
                    break;
                case 'pattern':
                    generatePatternBoard(type);
                    break;
                case 'coverall':
                    generateCoverallBoard(type);
                    break;
            }
        }

        // Generate BINGO Board (75/50 ball)
        function generateBingoBoard(type) {
            const board = document.getElementById('gameBoard');
            const wrapper = document.createElement('div');
            wrapper.className = type.id === '75ball' ? 'board-75-wrapper' : 'board-50-wrapper';
            
            // BINGO Labels
            const labels = document.createElement('div');
            labels.className = 'bingo-labels';
            'BINGO'.split('').forEach(letter => {
                const label = document.createElement('div');
                label.className = 'bingo-label';
                label.textContent = letter;
                labels.appendChild(label);
            });
            wrapper.appendChild(labels);
            
            // Board Grid
            const grid = document.createElement('div');
            grid.className = type.id === '75ball' ? 'board-75' : 'board-50';
            
            const columnRanges = type.id === '75ball' ? 
                [[1,15], [16,30], [31,45], [46,60], [61,75]] :
                [[1,10], [11,20], [21,30], [31,40], [41,50]];
            
            const columnNumbers = columnRanges.map(range => {
                let nums = new Set();
                while (nums.size < 5) {
                    nums.add(Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0]);
                }
                return Array.from(nums).sort((a, b) => a - b);
            });
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('button');
                    cell.className = 'board-cell';
                    
                    if (row === 2 && col === 2) {
                        cell.textContent = 'FREE';
                        cell.classList.add('center-cell');
                        cell.dataset.center = 'true';
                        cell.onclick = () => {
                            if (!cell.classList.contains('marked')) {
                                cell.classList.add('marked');
                                checkForWin();
                            }
                        };
                    } else {
                        const num = columnNumbers[col][row];
                        cell.textContent = num;
                        cell.dataset.number = num;
                        cell.dataset.row = row;
                        cell.dataset.column = col;
                        cell.onclick = () => toggleMark(cell, num);
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            wrapper.appendChild(grid);
            board.appendChild(wrapper);
        }

        // Generate 90 Ball Board
        function generate90BallBoard(type) {
            const board = document.getElementById('gameBoard');
            const wrapper = document.createElement('div');
            wrapper.className = 'board-90-wrapper';
            
            // Column labels
            const labels = document.createElement('div');
            labels.className = 'board-90-labels';
            for (let i = 1; i <= 9; i++) {
                const label = document.createElement('div');
                label.className = 'board-90-label';
                label.textContent = `${(i-1)*10+1}-${i*10}`;
                labels.appendChild(label);
            }
            wrapper.appendChild(labels);
            
            // Board Grid
            const grid = document.createElement('div');
            grid.className = 'board-90';
            
            const ranges = [
                [1,10], [11,20], [21,30], [31,40], [41,50],
                [51,60], [61,70], [71,80], [81,90]
            ];
            
            const columnNumbers = ranges.map(range => {
                const count = Math.floor(Math.random() * 2) + 1; // 1-2 numbers per column
                let nums = new Set();
                while (nums.size < count) {
                    nums.add(Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0]);
                }
                return Array.from(nums).sort((a, b) => a - b);
            });
            
            const layout = Array(3).fill().map(() => Array(9).fill(null));
            
            columnNumbers.forEach((nums, col) => {
                const positions = [0,1,2].sort(() => Math.random() - 0.5).slice(0, nums.length);
                positions.forEach((row, idx) => {
                    layout[row][col] = nums[idx];
                });
            });
            
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('button');
                    cell.className = 'board-cell';
                    const num = layout[row][col];
                    
                    if (num) {
                        cell.textContent = num;
                        cell.dataset.number = num;
                        cell.dataset.row = row;
                        cell.dataset.column = col;
                        
                        if (row === 1 && col === 4) {
                            cell.classList.add('center-cell');
                        }
                        
                        cell.onclick = () => toggleMark(cell, num);
                    } else {
                        cell.classList.add('blank-cell');
                        cell.textContent = '‚úó';
                        cell.disabled = true;
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            wrapper.appendChild(grid);
            board.appendChild(wrapper);
        }

        // Generate 30 Ball Board
        function generate30BallBoard(type) {
            const board = document.getElementById('gameBoard');
            const wrapper = document.createElement('div');
            wrapper.className = 'board-30-wrapper';
            
            // Column labels
            const labels = document.createElement('div');
            labels.className = 'board-30-labels';
            for (let i = 1; i <= 3; i++) {
                const label = document.createElement('div');
                label.className = 'board-30-label';
                label.textContent = `${(i-1)*10+1}-${i*10}`;
                labels.appendChild(label);
            }
            wrapper.appendChild(labels);
            
            // Board Grid
            const grid = document.createElement('div');
            grid.className = 'board-30';
            
            let nums = new Set();
            while (nums.size < 9) {
                nums.add(Math.floor(Math.random() * 30) + 1);
            }
            const numbers = Array.from(nums).sort((a, b) => a - b);
            
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('button');
                cell.className = 'board-cell';
                cell.textContent = numbers[i];
                cell.dataset.number = numbers[i];
                cell.dataset.index = i;
                
                if (i === 4) {
                    cell.classList.add('center-cell');
                }
                
                cell.onclick = () => toggleMark(cell, numbers[i]);
                grid.appendChild(cell);
            }
            
            wrapper.appendChild(grid);
            board.appendChild(wrapper);
        }

        // Generate Pattern Board
        function generatePatternBoard(type) {
            const board = document.getElementById('gameBoard');
            const wrapper = document.createElement('div');
            wrapper.className = 'board-pattern-wrapper';
            
            // BINGO Labels
            const labels = document.createElement('div');
            labels.className = 'board-pattern-labels';
            'BINGO'.split('').forEach(letter => {
                const label = document.createElement('div');
                label.className = 'board-pattern-label';
                label.textContent = letter;
                labels.appendChild(label);
            });
            wrapper.appendChild(labels);
            
            // Board Grid
            const grid = document.createElement('div');
            grid.className = 'board-pattern';
            
            const columnRanges = [[1,15], [16,30], [31,45], [46,60], [61,75]];
            const columnNumbers = columnRanges.map(range => {
                let nums = new Set();
                while (nums.size < 5) {
                    nums.add(Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0]);
                }
                return Array.from(nums).sort((a, b) => a - b);
            });
            
            // Define pattern cells
            const patternCells = getPatternCells(gameState.currentPattern);
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('button');
                    cell.className = 'board-cell';
                    
                    if (row === 2 && col === 2) {
                        cell.textContent = 'FREE';
                        cell.classList.add('center-cell');
                        cell.dataset.center = 'true';
                        cell.onclick = () => {
                            if (!cell.classList.contains('marked')) {
                                cell.classList.add('marked');
                                checkForWin();
                            }
                        };
                    } else {
                        const num = columnNumbers[col][row];
                        cell.textContent = num;
                        cell.dataset.number = num;
                        cell.dataset.row = row;
                        cell.dataset.column = col;
                        
                        if (patternCells.includes(`${row}-${col}`)) {
                            cell.classList.add('pattern-cell');
                        }
                        
                        cell.onclick = () => toggleMark(cell, num);
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            wrapper.appendChild(grid);
            board.appendChild(wrapper);
        }

        // Generate Coverall Board
        function generateCoverallBoard(type) {
            const board = document.getElementById('gameBoard');
            const wrapper = document.createElement('div');
            wrapper.className = 'board-coverall-wrapper';
            
            // Column labels
            const labels = document.createElement('div');
            labels.className = 'board-coverall-labels';
            for (let i = 1; i <= 9; i++) {
                const label = document.createElement('div');
                label.className = 'board-coverall-label';
                label.textContent = `${(i-1)*10+1}-${i*10}`;
                labels.appendChild(label);
            }
            wrapper.appendChild(labels);
            
            // Board Grid
            const grid = document.createElement('div');
            grid.className = 'board-coverall';
            
            let allNumbers = Array.from({length: 90}, (_, i) => i + 1);
            allNumbers = shuffleArray(allNumbers).slice(0, 45);
            
            for (let i = 0; i < 45; i++) {
                const row = Math.floor(i / 9);
                const col = i % 9;
                const cell = document.createElement('button');
                cell.className = 'board-cell';
                cell.textContent = allNumbers[i];
                cell.dataset.number = allNumbers[i];
                cell.dataset.index = i;
                
                if (row === 2 && col === 4) {
                    cell.classList.add('center-cell');
                }
                
                cell.onclick = () => toggleMark(cell, allNumbers[i]);
                grid.appendChild(cell);
            }
            
            wrapper.appendChild(grid);
            board.appendChild(wrapper);
        }

        // Get pattern cells
        function getPatternCells(pattern) {
            const patterns = {
                'x-pattern': ['0-0', '0-4', '1-1', '1-3', '2-2', '3-1', '3-3', '4-0', '4-4'],
                'frame': ['0-0', '0-1', '0-2', '0-3', '0-4', '4-0', '4-1', '4-2', '4-3', '4-4', '1-0', '2-0', '3-0', '1-4', '2-4', '3-4'],
                'postage-stamp': ['0-0', '0-1', '1-0', '1-1', '3-3', '3-4', '4-3', '4-4'],
                'small-diamond': ['1-2', '2-1', '2-2', '2-3', '3-2']
            };
            return patterns[pattern] || patterns['x-pattern'];
        }

        // Shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Toggle Mark
        function toggleMark(cell, number) {
            if (!gameState.gameActive) {
                showNotification('Game not started yet', false);
                return;
            }
            
            // Check if number has been called
            if (!gameState.calledNumbers.includes(number)) {
                showNotification('This number has not been called yet', false);
                return;
            }
            
            if (cell.classList.contains('marked')) {
                cell.classList.remove('marked');
                gameState.markedNumbers.delete(number);
            } else {
                cell.classList.add('marked');
                gameState.markedNumbers.add(number);
                checkForWin();
            }
        }

        // Check for win automatically
        function checkForWin() {
            const win = calculateWin();
            if (win) {
                // Highlight winning cells
                highlightWinningCells(win.pattern);
                // Enable winner button
                document.getElementById('announceBtn').style.background = '#dc3545';
                document.getElementById('announceBtn').style.animation = 'pulseFast 0.5s infinite';
            }
        }

        // Calculate Win
        function calculateWin() {
            const type = gameState.gameType;
            const patterns = gameState.winningPatterns[type];
            
            for (const pattern of patterns) {
                if (checkPattern(pattern)) {
                    return { pattern: pattern };
                }
            }
            
            return null;
        }

        // Check Specific Pattern
        function checkPattern(pattern) {
            switch(gameState.gameType) {
                case '75ball':
                case '50ball':
                    return check75BallPattern(pattern);
                case '90ball':
                    return check90BallPattern(pattern);
                case '30ball':
                    return check30BallPattern(pattern);
                case 'pattern':
                    return checkPatternBingo(pattern);
                case 'coverall':
                    return checkCoverallPattern(pattern);
                default:
                    return false;
            }
        }

        // Check 75-Ball Patterns
        function check75BallPattern(pattern) {
            const cells = document.querySelectorAll('.board-cell:not(.blank-cell)');
            
            switch(pattern) {
                case 'row':
                    for (let row = 0; row < 5; row++) {
                        let complete = true;
                        for (let col = 0; col < 5; col++) {
                            const cell = document.querySelector(`.board-cell[data-row="${row}"][data-column="${col}"]`);
                            if (!cell || (!cell.classList.contains('marked') && !(row === 2 && col === 2))) {
                                complete = false;
                                break;
                            }
                        }
                        if (complete) return true;
                    }
                    return false;
                    
                case 'column':
                    for (let col = 0; col < 5; col++) {
                        let complete = true;
                        for (let row = 0; row < 5; row++) {
                            const cell = document.querySelector(`.board-cell[data-row="${row}"][data-column="${col}"]`);
                            if (!cell || (!cell.classList.contains('marked') && !(row === 2 && col === 2))) {
                                complete = false;
                                break;
                            }
                        }
                        if (complete) return true;
                    }
                    return false;
                    
                case 'diagonal':
                    // Main diagonal
                    let diag1Complete = true;
                    for (let i = 0; i < 5; i++) {
                        const cell = document.querySelector(`.board-cell[data-row="${i}"][data-column="${i}"]`);
                        if (!cell || (!cell.classList.contains('marked') && !(i === 2))) {
                            diag1Complete = false;
                            break;
                        }
                    }
                    if (diag1Complete) return true;
                    
                    // Anti-diagonal
                    let diag2Complete = true;
                    for (let i = 0; i < 5; i++) {
                        const cell = document.querySelector(`.board-cell[data-row="${i}"][data-column="${4-i}"]`);
                        if (!cell || (!cell.classList.contains('marked') && !(i === 2))) {
                            diag2Complete = false;
                            break;
                        }
                    }
                    return diag2Complete;
                    
                case 'four-corners':
                    const corners = [
                        document.querySelector('.board-cell[data-row="0"][data-column="0"]'),
                        document.querySelector('.board-cell[data-row="0"][data-column="4"]'),
                        document.querySelector('.board-cell[data-row="4"][data-column="0"]'),
                        document.querySelector('.board-cell[data-row="4"][data-column="4"]')
                    ];
                    return corners.every(cell => cell && cell.classList.contains('marked'));
                    
                case 'full-house':
                    const allCells = document.querySelectorAll('.board-cell:not(.blank-cell)');
                    return Array.from(allCells).every(cell => 
                        cell.classList.contains('marked') || cell.classList.contains('center-cell')
                    );
                    
                default:
                    return false;
            }
        }

        // Check 90-Ball Patterns
        function check90BallPattern(pattern) {
            const rows = 3;
            const cols = 9;
            let markedRows = 0;
            
            for (let row = 0; row < rows; row++) {
                let rowComplete = true;
                for (let col = 0; col < cols; col++) {
                    const cell = document.querySelector(`.board-cell[data-row="${row}"][data-column="${col}"]`);
                    if (cell && !cell.classList.contains('blank-cell') && !cell.classList.contains('marked')) {
                        rowComplete = false;
                        break;
                    }
                }
                if (rowComplete) markedRows++;
            }
            
            switch(pattern) {
                case 'one-line':
                    return markedRows >= 1;
                case 'two-lines':
                    return markedRows >= 2;
                case 'full-house':
                    return markedRows === 3;
                default:
                    return false;
            }
        }

        // Check 30-Ball Pattern
        function check30BallPattern(pattern) {
            if (pattern === 'full-house') {
                const cells = document.querySelectorAll('.board-cell');
                return Array.from(cells).every(cell => cell.classList.contains('marked'));
            }
            return false;
        }

        // Check Pattern Bingo
        function checkPatternBingo(pattern) {
            const patternCells = getPatternCells(pattern);
            return patternCells.every(pos => {
                const [row, col] = pos.split('-').map(Number);
                const cell = document.querySelector(`.board-cell[data-row="${row}"][data-column="${col}"]`);
                return cell && (cell.classList.contains('marked') || cell.classList.contains('center-cell'));
            });
        }

        // Check Coverall Pattern
        function checkCoverallPattern(pattern) {
            if (pattern === 'full-board') {
                const cells = document.querySelectorAll('.board-cell');
                return Array.from(cells).every(cell => cell.classList.contains('marked'));
            }
            return false;
        }

        // Highlight winning cells
        function highlightWinningCells(pattern) {
            // Reset previous highlights
            document.querySelectorAll('.board-cell').forEach(cell => {
                cell.classList.remove('winner-highlight');
            });
            
            // Add highlight to winning cells based on pattern
            // This is a simplified version - you can expand based on actual winning cells
            document.querySelectorAll('.board-cell.marked').forEach(cell => {
                cell.classList.add('winner-highlight');
            });
        }

        // Update Called Numbers Display
        function updateCalledNumbersDisplay() {
            const bar = document.getElementById('calledNumbersBar');
            bar.innerHTML = '';
            
            gameState.calledNumbers.forEach(num => {
                const span = document.createElement('span');
                span.className = 'called-number';
                span.textContent = num;
                bar.appendChild(span);
            });
            
            if (gameState.calledNumbers.length === 0) {
                bar.innerHTML = '<span style="color: #888; font-style: italic;">Numbers will appear here...</span>';
            }
        }

        // Announce Win
        function announceWin() {
            if (!gameState.gameActive) {
                showNotification('Game not active', false);
                return;
            }
            
            const win = calculateWin();
            if (win) {
                const winAmount = calculatePotentialWin(gameState.stake);
                
                // Send win claim to server
                const success = sendMessage({
                    type: 'claim_win',
                    playerName: gameState.playerName,
                    playerId: gameState.playerId,
                    pattern: win.pattern,
                    amount: winAmount
                });
                
                if (success) {
                    // Show local notification
                    document.getElementById('winnerName').textContent = gameState.playerName;
                    document.getElementById('winPattern').textContent = gameState.winConditions[win.pattern] || win.pattern;
                    document.getElementById('displayWinAmount').textContent = `${winAmount.toLocaleString()} Birr`;
                    document.getElementById('winnerStatus').textContent = 'Verifying...';
                    document.getElementById('continueGameBtn').style.display = 'none';
                    document.getElementById('winnerNotification').style.display = 'block';
                    
                    const audio = document.getElementById('winAudio');
                    audio.currentTime = 0;
                    audio.play().catch(() => {});
                }
            } else {
                showNotification('No winning pattern completed. Please check again!', false);
            }
        }

        // Continue Game
        function continueGame() {
            document.getElementById('winnerNotification').style.display = 'none';
            // Reset winner button
            document.getElementById('announceBtn').style.background = '';
            document.getElementById('announceBtn').style.animation = '';
        }

        // Update Finance
        function updateFinance() {
            const balance = gameState.payment + gameState.totalWon - gameState.totalWithdrawn;
            const withdraw = Math.floor(balance * 0.97);
            
            document.getElementById('totalPayment').value = `${gameState.payment} Birr`;
            document.getElementById('totalWon').value = `${gameState.totalWon.toLocaleString()} Birr`;
            document.getElementById('currentBalance').value = `${balance.toLocaleString()} Birr`;
            document.getElementById('withdrawAmount').value = `${withdraw.toLocaleString()} Birr`;
        }

        // Process Withdrawal
        function processWithdrawal() {
            const account = document.getElementById('withdrawAccount').value;
            const amount = parseInt(document.getElementById('withdrawAmount').value.replace(/,/g, ''));
            
            if (!account) {
                showNotification('Please enter account number', false);
                return;
            }
            
            if (amount < 25) {
                showNotification('Minimum withdrawal is 25 Birr', false);
                return;
            }
            
            const balance = gameState.payment + gameState.totalWon - gameState.totalWithdrawn;
            if (amount > balance) {
                showNotification('Insufficient balance', false);
                return;
            }
            
            // Simulate withdrawal - in real app, this would call an API
            gameState.totalWithdrawn += amount;
            updateFinance();
            showNotification(`${amount.toLocaleString()} Birr withdrawn successfully!`, false);
            
            // Clear account field
            document.getElementById('withdrawAccount').value = '';
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
        
        // Mobile compatibility
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gesturestart', (e) => e.preventDefault());
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        
        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 0);
                if (gameState.gameType) {
                    generateGameBoard();
                }
            }, 100);
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            const membersModal = document.getElementById('membersModal');
            const potentialWinModal = document.getElementById('potentialWinModal');
            
            if (e.target === membersModal) {
                membersModal.style.display = 'none';
            }
            if (e.target === potentialWinModal) {
                potentialWinModal.style.display = 'none';
            }
        });
        
        // Ensure boards fit on resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (gameState.gameType) {
                    generateGameBoard();
                }
            }, 250);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (gameState.ws) {
                gameState.ws.close();
            }
            if (gameState.reconnectTimeout) {
                clearTimeout(gameState.reconnectTimeout);
            }
            if (gameState.pingInterval) {
                clearInterval(gameState.pingInterval);
            }
        });
    </script>
</body>
</html>
